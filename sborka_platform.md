# Сборка БЭМ-проекта

[Сборка](sborka_method.md) - неотъемлемое понятие БЭМ-методологии. У сборки БЭМ-проектов есть масса нюансов, связанных с предметной областью платформы.

Собирать сайт лучше автоматически, с помощью соответствующих инструментов. Для БЭМ-проектов мы рекомендуем использовать [ENB](http://enb-make.info/) или [bem-tools](https://ru.bem.info/tools/bem/bem-tools/).

## Этапы сборки

### Создание декларации

[Декларации бандлов](sborka_method.md#decl) пишутся вручную или могут быть получены с сервера, в зависимости от [специфики проекта](#cases). В БЭМ-проектах мы часто используем формат [BEMJSON](https://ru.bem.info/technology/bemjson/current/bemjson/)-декларации, который валидно обрабатывается сборщиками `ENB` и `bem-tools`.

### Файл bemdecl.js

Как правило, файл `<имя_бандла>.bemdecl.js` генерируется сборщиком на основе декларации и служит основой для последующего создания [файла с зависимостями](#depen).

Файл [bemdecl.js](http://frontend.yandex-team.ru/packages/docs/bem/formats/bemdecl.md.html) содержит дерево всех сущностей, реализации которых необходимо собрать: без контента, без повторяющихся участков, без учета вложенности, но с сохранением порядка декларации сущностей. Заключенная в нем информация помогает понять, с каких блоков начинать процесс раскрытия зависимостей.

<a name="depen"></a>
### Зависимости

В процессе сборки необходимо описать все зависимости между сущностями и библиотеками. Для этого, на основе декларации бандла, инструменты сборки генерируют специальные файлы зависимостей. В БЭМ мы используем файлы [технологии deps.js](http://ru.bem.info/tools/bem/bem-tools/depsjs/).

Файл `<имя_бандла>.deps.js` обычно представляет собой упорядоченный массив, описывающий зависимости сущностей бандла от других сущностей и от технологий. При генерации файла учитывается, какие библиотеки были подключены в `dependencies` в `bower.json`.

Существует также [исходный формат](http://frontend.yandex-team.ru/packages/docs/bem/formats/deps.md.html) `deps.js`, описывающий зависимости конкретной сущности.

### Файлы технологий

Результат процесса сборки БЭМ-проекта - объединенные файлы технологий. На основе `deps.js` для каждого бандла создается свой пакет файлов: отдельный файл для каждой из технологий, используемых при реализации бандла.

К технологиям относятся HTML, CSS, JavaScript, тесты и прочее.

Разработчик описывает стили и поведение отдельно для каждого блока, после чего сборщик объединяет все касающиеся бандла правила в нескольких оптимизированных файлах. К примеру,

![Сборка CSS-файлов](https://img-fotki.yandex.ru/get/15591/158800653.0/0_111c54_e7a227ff_orig)

Файл каждой технологии оптимизируется по-своему, в зависимости от настроек инструмента сборки. Обычно процесс генерации проходит в два этапа:

1. Создание объединенных файлов `<имя_бандла>.<расширение_технологии>`;
2. Оптимизация объединенных файлов, сохранение результата в `_<имя_бандла>.<расширение_технологии>`.

Для платформы БЭМ разработаны следующие оптимизаторы:

* [borschik](http://ru.bem.info/tools/optimizers/borschik/)
* [CSSO](http://ru.bem.info/tools/optimizers/csso/)
* [SVGO](http://ru.bem.info/tools/optimizers/svgo/how-it-works/)

<a name="cases"></a>

## Стандартные кейсы сборки

В общем случае процесс сборки можно представить следующим образом:

![Общая схема сборки](http://img-fotki.yandex.ru/get/6837/158800653.0/0_10741c_bfcdd557_orig)

При этом, рационально оптимизировать ход процесса в зависимости от специфики проекта.

### Статическая сборка страницы

В случае разработки статических страниц BEMJSON-декларация пишется вручную. На ее основе автоматически генерируется плоский список в формате BEMDECL.

**Схема сборки** (TODO):

Декларируем все сущности страницы в `index.bemjson.js`  
->  
Указываем таргет для сборщика и запускаем процесс сборки  
->  
Сборщик создает `index.bemdecl.js` на основе декларации  
->  
Сборщик создает `index.deps.js` на основе списка сущностей из `index.bemdecl.js`  
->  
Сборщик объединяет код технологий, используемых для реализации страницы, в отдельные merged-файлы  
->  
Сборщик задействует инструменты оптимизации кода, отдельный для каждой технологий, согласно конфигурации сборки  
->  
Сборщик сохраняет оптимизированный код в отдельные файлы по технологиям: `_index.<расширение_технологии>`

<a name="dinam"></a>
### Динамическая сборка страницы

При разработке динамической страницы [БЭМ-дерево](http://ru.bem.info/method/definitions/#Средства-описания-страницы-и-шаблоны) отсутствует на этапе сборки, а содержимое BEMJSON-декларации зависит от состояния блоков. В этом случае процесс сборки начинается с файла `bemdecl.js`, который предварительно составляется вручную.

**Схема сборки** (TODO):

Описываем все сущности страницы в `index.bemdecl.js`  
->  
Указываем таргет для сборщика и запускаем процесс сборки  
->  
Сборщик создает `index.deps.js` на основе списка сущностей из `index.bemdecl.js`  
->  
Сборщик объединяет код технологий, используемых для реализации страницы, в отдельные merged-файлы  
->  
Сборщик задействует инструменты оптимизации кода, отдельный для каждой технологий, согласно конфигурации сборки  
->  
Сборщик сохраняет оптимизированный код в отдельные файлы по технологиям: `_index.<расширение_технологии>`
