# Сборка БЭМ-проекта

[Сборка](sborka_method.md) - неотъемлемое понятие БЭМ-методологии. У сборки БЭМ-проектов есть масса нюансов, связанных с предметной областью платформы.

Собирать сайт лучше автоматически, с помощью соответствующих инструментов. Для БЭМ-проектов мы рекомендуем использовать [ENB](http://enb-make.info/) или [bem-tools](https://ru.bem.info/tools/bem/bem-tools/).

## Файловая структура БЭМ-проекта до сборки

На этапе разработки типичная структура БЭМ-сайта может выглядеть так:

```sh
.enb/      # конфигурация ENB
└── make.js
.bem/      # конфигурация bem-tools
└── make.js
└── level.js
blocks/      # блоки
bundles/      # бандлы
├── index/      # папка бандла
    ├── index.bemjson.js      # JS-декларация бандла
bower.json      # config-файл, отвечающий за подключение библиотек
...
```
Рассмотрим подробнее элементы подобного дерева.

### Конфигурационные файлы сборки

В свои проекты мы включаем файлы конфигурации для обоих приоритетных инструментов сборки.

Файл `.enb\make.js` конфигурирует сборщик `ENB` и задаёт таргеты (цели) для сборки проекта.

В папке `.bem` находятся [config-файлы](http://ru.bem.info/tools/bem/bem-tools/customization/) `bem-tools`:
* `level.js` задает подключаемые уровни переопределения для блоков;
* `make.js` (опциональный) переопределяет ключевые узлы сборки.

Лежащий в корне проекта файл `bower.json` отвечает за [подключение библиотек](http://ru.bem.info/tutorials/start-with-project-stub/#Подключение-библиотек).

### Папки блоков

В папках блоков размещаются файлы технологий, касающиеся данного блока. К примеру,

```sh
blocks/
├── button/      # папка блока button
    ├── button.html
    ├── button.css
    ├── button.js
```

### Декларации бандлов

Отдельные фрагменты сайта мы, как правило, выделяем в *бандлы*. Примером бандла может служить шапка сайта, включающая в себя блоки логотипа, меню и поиска. Шапка - повторяющийся от страницы к странице фрагмент, поэтому логично декларировать все ее зависимости в одном файле и генерировать для нее отдельный пакет итоговых файлов.

Декларация перечисляет сущности бандла согласно определенным правилам. Ее формат произволен. Мы часто используем [BEMJSON](https://ru.bem.info/technology/bemjson/current/bemjson/), который валидно обрабатывается сборщиками `ENB` и `bem-tools`.

Именно на основe декларации инструменты сборки подтягивают все составляющие бандла и зависящие от них блоки. Теоретически можно обойтись без такого рода декларации вовсе и написать плоский список всех компонентов сайта вручную. Это оптимальный вариант при [динамическом создании страницы](#dinam).

## Файлы генерируемые инструментами сборки

### Файлы технологий

Результат процесса сборки БЭМ-проекта - объединенные файлы технологий. Для каждого бандла создается свой пакет файлов: отдельный файл для каждой из технологий, используемых при реализации бандла.

К технологиям относятся HTML, CSS, JavaScript, тесты и прочее.

Разработчик описывает стили и поведение отдельно для каждого блока, после чего сборщик объединяет все касающиеся бандла правила в нескольких оптимизированных файлах. К примеру,

![Сборка CSS-файлов](https://img-fotki.yandex.ru/get/15591/158800653.0/0_111c54_e7a227ff_orig)

Файл каждой технологии оптимизируется по-своему, в зависимости от настроек инструмента сборки. Обычно процесс генерации проходит в два этапа:

1. Создание объединенных файлов `<имя_бандла>.<расширение_технологии>`;
2. Оптимизация объединенных файлов, сохранение результата в `_<имя_бандла>.<расширение_технологии>`.

### Зависимости

Прежде чем собирать правила воедино по технологиям, необходимо описать все зависимости между сущностями и библиотеками. Для этого, на основе декларации бандла, инструменты сборки генерируют специальные файлы зависимостей. В БЭМ мы используем файлы [технологии deps.js](http://ru.bem.info/tools/bem/bem-tools/depsjs/).

Файл `<имя_бандла>.deps.js` обычно представляет собой упорядоченный массив, описывающий зависимости сущностей бандла от других сущностей и от технологий. При генерации файла учитывается, какие библиотеки были подключены в `dependencies` в `bower.json`.

Существует также [исходный формат](http://frontend.yandex-team.ru/packages/docs/bem/formats/deps.md.html) `deps.js`, описывающий зависимости конкретной сущности.

### Файл bemdecl.js

Основой для создания файла с зависимостями, в свою очередь, служит файл `<имя_бандла>.bemdecl.js`. Как правило, он генерируется сборщиком на основе декларации.

Файл [bemdecl.js](http://frontend.yandex-team.ru/packages/docs/bem/formats/bemdecl.md.html) содержит дерево всех сущностей, реализации которых необходимо собрать: без контента, без повторяющихся участков, без учета вложенности, но с сохранением порядка декларации сущностей. Эта информация помогает понять, с каких блоков начинать процесс раскрытия зависимостей.

## Стандартные кейсы сборки
<TODO>

В общем случае процесс сборки можно представить следующим образом:

![Общая схема сборки](http://img-fotki.yandex.ru/get/6837/158800653.0/0_10741c_bfcdd557_orig)

Однако, рационально оптимизировать ход процесса в зависимости от специфики проекта.

### Статическая сборка страницы

В случае разработки статических страниц bemjson-декларация пишется вручную.

<a name="dinam"></a>
### Динамическая сборка страницы

При разработке динамической страницы содержимое её bemjson-декларации зависит от состояния блоков. Декларация приходит с сервера.

### Вычитание и объединение деклараций

Декларации можно [вычитать и объединять](http://ru.bem.info/tools/bem/bem-tools/customization/#Сборка-`merged`-бандла--раньше-так-же-назывался-`common`-).
