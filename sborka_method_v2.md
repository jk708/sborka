*Пустые ссылки - на намеченный документ о файловой системе.*

# Методология сборки

## Понятие сборки

При работе с большими сайтами, как правило, сложно следить за кодом всего проекта и производить его рефакторинг. Многие разработчики предпочитают разбивать сайт на множество маленьких взаимосвязанных файлов, с которыми удобно работать (читайте подробнее [о файловой системе сайта]()). Однако исходный проект, с которым работает человек, не подходит для выкладки на сервер: браузер будет обрабатывать такой сайт неоправданно медленно, а число запросов на сервер возрастет.

Для решения проблемы готовый проект **собирают**, трансформируя файловую структуру сайта и оптимизируя код страниц.

![Код для людей в код для роботов](https://img-fotki.yandex.ru/get/16165/158800653.0/0_111c55_72635305_orig)

Сборка, таким образом, предоставляет два основных преимущества:

* удобство поддержки сайта не идет в ущерб скорости его обработки браузером;
* слияние файлов по [технологиям]() снижает количество запросов на сервер.

Использование БЭМ-платформы в создании сайта позволяет упростить процесс сборки и предоставляет широкий функционал для ее гибкой настройки.

## Инструменты сборки

Для автоматической сборки сайта применяют специальные **инструменты сборки**. Вы можете написать уникальный инструмент для своего проекта или использовать один из уже существующих. К примеру,

* [Gulp](http://gulpjs.com/)
* [Grunt](http://gruntjs.com/)
* [Brunch](http://brunch.io/)
* [Broccoli](https://www.npmjs.org/package/broccoli)

Для сборки БЭМ-проектов мы рекомендуем использовать инструменты, оптимизированные для работы с концепцией БЭМ:

* [ENB](http://enb-make.info/), или
* [bem-tools](https://ru.bem.info/tools/bem/bem-tools/)

**На вход** сборщик получает сайт с абстрактной файловой структурой и множеством разрозненных файлов.

**В процессе** сборщик, на основании конфигурационного файла и собственных алгоритмов:

* объединяет раздробленные маленькие файлы в цельные, по предназначению;
* задействует нужные шаблоны;
* подключает сущности из библиотек согласно зависимостям;
* оптимизирует код (например, раскрывает `import` в CSS);
* удаляет служебные знаки (например, отступы и пробелы) и т.д.

**На выход** сборщик выдает компактный набор папок и файлов, занимающий наименьшее место на сервере и максимально быстро обрабатываемый браузером.

Рассмотрим пример оптимизации CSS шапки сайта в общем случае. Опираясь на зависимости между файлами, сборщик собирает все листы стилей, описывающие внешний вид шапки, и сливает их в один большой оптимизированный файл.

![Сборка CSS](https://img-fotki.yandex.ru/get/16191/158800653.1/0_1160d2_dd1f983d_orig)

## Сборка в БЭМ-методологии

БЭМ-методология позволяет собрать как сайт целиком, так и отдельную страницу (или даже фрагмент страницы). При этом разработчик получает доступ к готовым механизмам оптимизации процесса сборки.

<a name="decl"></a>
### Использование деклараций

Обычно, после внесения изменений в проект и перед выкладкой на сервер, его пересобирают. При этом необходимо вручную отслеживать, какие части проекта были добавлены или удалены. Упростить задачу помогает использование понятия **декларации** - упорядоченного списка всех составляющих страницы, на основании которого она последовательно собирается.

Декларация указывает:

* какие блоки сайта собирать;
* какие библиотеки подключать;
* как сущности зависят друг от друга, и т.д.

Декларация позволяет задать только необходимые компоненты страницы, которые будут собраны с определенных [уровней переопределения](#levels). Сущности, указанные в зависимостях этих компонентов, также автоматически подключаются в процессе сборки.

Формат декларации произволен. В БЭМ мы используем [BEMJSON](http://ru.bem.info/technology/bemjson/current/bemjson/).

![BEMJSON](https://img-fotki.yandex.ru/get/16122/158800653.1/0_11568f_e0c04ef4_orig)

Исходный BEMJSON-файл создается разработчиком вручную и содержит описание лишь ключевых БЭМ-сущностей, которые становятся точками входа для шаблонизатора [BEMTREE](http://ru.bem.info/technology/bemtree/current/bemtree/).

BEMTREE поэлементно выстраивает [БЭМ-дерево]() документа, рекурсивно включая ссылки на другие сущности и применяя к ним шаблоны.

BEMJSON-файл, сгенерированный BEMTREE, передается на вход шаблонизатору [BEMHTML](http://ru.bem.info/technology/bemhtml/v2/rationale/), основная задача которого - преобразовать БЭМ-дерево в HTML, попутно интегрировав его с CSS и JavaScript в стиле БЭМ.

Таким образом, кратко описав страницу в терминах БЭМ, благодаря автоматизированному применению шаблонов и раскрытию зависимостей, на выходе мы получаем стандартный набор файлов, реализующих страницу: HTML+CSS+JS.

Читайте подробнее о понятии [декларации в БЭМ-методологии]().

<a name="levels"></a>
### Использование уровней переопределения

Случается, что перед повторной сборкой разработчик хочет переопределить вид некоторых компонентов сайта, не затрагивая код имеющихся библиотек. Например, для того, чтобы представить блок по-разному на мобильных и десктопных устройствах. В БЭМ-методологии применяется понятие [уровней переопределения](), которые решают проблему повторного использования кода.

Каждому уровню соответствует директория, в которой хранятся файлы с кодом, дополняющим или переопределяющим внешний вид и поведение блоков. [Декларируя](#decl) описание страницы, можно повлиять на ее представление указав список нужных в конкретном случае уровней.

### Сборка отдельных компонентов

В БЭМ существует понятие [бандла]() - набора итоговых [файлов технологий](), составляющих отдельную функциональную часть сайта. Примерами могут служить шапка или меню.

Для каждого бандла при разработке создается отдельная директория, в которой размещают его [декларацию](#decl). Декларация задает блоки и элементы, реализующие бандл, и технологии, которые используются при реализации. Сборщик собирает код указанных компонентов и последовательно сливает их в цельные файлы технологий (называемые также **бандлами технологий**).

Подобный подход упрощает как разработку, так и сам процесс сборки, позволяя пересобирать только измененные фрагменты сайта.

Существуют [готовые решения]() для сборки БЭМ-проектов.
